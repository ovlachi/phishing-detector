<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phishing & Malware Detection</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
  </head>
  <body>
    <div class="auth-bar">
      <span id="user-status">Not logged in</span>
      <a href="/login" id="login-link">Login</a>
      <a href="/logout" id="logout-link" style="display: none">Logout</a>
    </div>

    <h1>Phishing & Malware Detection</h1>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('single')">Single URL</div>
      <div class="tab" onclick="switchTab('batch')">Batch URLs</div>
    </div>

    <div id="single-tab" class="tab-content active container">
      <div class="input-group">
        <label for="url-input">Enter URL to check:</label>
        <input type="text" id="url-input" placeholder="https://example.com" />
      </div>
      <button onclick="analyzeSingleUrl()">Analyze URL <span id="single-loader" class="loader"></span></button>
    </div>

    <div id="batch-tab" class="tab-content container">
      <div class="auth-note" id="batch-auth-note">
        You need to be logged in to use batch URL analysis.
        <a href="/login">Login now</a>
      </div>

      <div class="input-group">
        <label for="urls-input">Enter URLs to check (one per line):</label>
        <textarea
          id="urls-input"
          placeholder="https://example.com
https://example.org"
        ></textarea>
      </div>
      <button onclick="analyzeBatchUrls()" id="batch-button" disabled>Analyze URLs <span id="batch-loader" class="loader"></span></button>
    </div>

    <div id="results" style="display: none"></div>

    <script>
      // Check authentication status
      let isAuthenticated = false;

      function checkAuth() {
        // Debug: show all cookies
        console.log("All cookies:", document.cookie);

        // Check if we have a token cookie
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          console.log("Processing cookie:", cookie);
          const parts = cookie.trim().split("=");
          const name = parts[0];
          const value = parts.slice(1).join("="); // Handle values that might contain =

          console.log("Cookie name:", name, "value:", value);
          if (name === "access_token" && value) {
            isAuthenticated = true;
            console.log("Authentication detected!");
            break;
          }
        }

        // Update UI based on auth status
        if (isAuthenticated) {
          document.getElementById("user-status").textContent = "Logged in";
          document.getElementById("login-link").style.display = "none";
          document.getElementById("logout-link").style.display = "inline";
          document.getElementById("batch-auth-note").style.display = "none";
          document.getElementById("batch-button").disabled = false;
        } else {
          document.getElementById("user-status").textContent = "Not logged in";
          document.getElementById("login-link").style.display = "inline";
          document.getElementById("logout-link").style.display = "none";
          document.getElementById("batch-auth-note").style.display = "block";
          document.getElementById("batch-button").disabled = true;
        }
      }

      // Check auth on page load
      document.addEventListener("DOMContentLoaded", checkAuth);

      function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab
        document.getElementById(`${tabName}-tab`).classList.add("active");
        document.querySelector(`.tab:nth-child(${tabName === "single" ? 1 : 2})`).classList.add("active");
      }

      function showLoader(type) {
        document.getElementById(`${type}-loader`).style.display = "inline-block";
      }

      function hideLoader(type) {
        document.getElementById(`${type}-loader`).style.display = "none";
      }

      function analyzeSingleUrl() {
        const url = document.getElementById("url-input").value.trim();
        if (!url) {
          alert("Please enter a URL");
          return;
        }

        showLoader("single");

        fetch("/classify", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ url })
        })
          .then((response) => response.json())
          .then((data) => {
            hideLoader("single");
            displayResults([data]);
          })
          .catch((error) => {
            hideLoader("single");
            console.error("Error:", error);
            alert("An error occurred. Please try again.");
          });
      }

      function analyzeBatchUrls() {
        if (!isAuthenticated) {
          alert("Please login to use batch URL analysis");
          window.location.href = "/login";
          return;
        }

        const urlsText = document.getElementById("urls-input").value.trim();
        if (!urlsText) {
          alert("Please enter at least one URL");
          return;
        }

        const urls = urlsText
          .split("\n")
          .map((url) => url.trim())
          .filter((url) => url !== "");

        if (urls.length === 0) {
          alert("Please enter at least one valid URL");
          return;
        }

        showLoader("batch");

        // Get token from cookie
        let token = "";
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
          const [name, value] = cookie.trim().split("=");
          if (name === "access_token") {
            token = value.replace("Bearer ", "");
            break;
          }
        }

        fetch("/classify-batch", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ urls })
        })
          .then((response) => {
            if (response.status === 401) {
              // Unauthorized - token expired or invalid
              isAuthenticated = false;
              checkAuth();
              alert("Your session has expired. Please login again.");
              window.location.href = "/login";
              throw new Error("Unauthorized");
            }
            return response.json();
          })
          .then((data) => {
            hideLoader("batch");
            displayResults(data.results);
            console.log(`Processing time: ${data.processing_time.toFixed(2)} seconds`);
          })
          .catch((error) => {
            hideLoader("batch");
            if (error.message !== "Unauthorized") {
              console.error("Error:", error);
              alert("An error occurred. Please try again.");
            }
          });
      }

      function displayResults(results) {
        const resultsDiv = document.getElementById("results");
        resultsDiv.style.display = "block";
        resultsDiv.innerHTML = "<h2>Results</h2>";

        results.forEach((result) => {
          const resultItem = document.createElement("div");
          resultItem.className = "result-item";

          if (result.error) {
            resultItem.innerHTML = `
                        <div><strong>URL:</strong> ${result.url}</div>
                        <div class="error">Error: ${result.error}</div>
                    `;
          } else {
            let classStyle = "";
            if (result.class_name === "Legitimate") classStyle = "legitimate";
            else if (result.class_name === "Credential Phishing") classStyle = "phishing";
            else if (result.class_name === "Malware Distribution") classStyle = "malware";

            let probabilityBars = "";
            if (result.probabilities) {
              const barColors = {
                Legitimate: "#2ecc71",
                "Credential Phishing": "#e74c3c",
                "Malware Distribution": "#c0392b"
              };

              probabilityBars = '<div class="probability-bar">';
              for (const [className, prob] of Object.entries(result.probabilities)) {
                probabilityBars += `
                                <div class="probability-segment" 
                                     style="width: ${prob * 100}%; background-color: ${barColors[className] || "#999"};"
                                     title="${className}: ${(prob * 100).toFixed(1)}%">
                                </div>
                            `;
              }
              probabilityBars += "</div>";
            }

            resultItem.innerHTML = `
                        <div><strong>URL:</strong> ${result.url}</div>
                        <div><strong>Classification:</strong> <span class="${classStyle}">${result.class_name}</span></div>
                        ${probabilityBars}
                        <div style="margin-top: 5px;">
                            <strong>Probabilities:</strong>
                            ${Object.entries(result.probabilities || {})
                              .map(([className, prob]) => `${className}: ${(prob * 100).toFixed(1)}%`)
                              .join(", ")}
                        </div>
                    `;
          }

          resultsDiv.appendChild(resultItem);
        });
      }
    </script>
  </body>
</html>
